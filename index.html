<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blite: Chat Anonyme Kinshasa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        /* Style to hide the scrollbar while keeping it functional */
        #chat-window {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        #chat-window::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div id="app" class="w-full max-w-2xl bg-white p-4 sm:p-6 rounded-xl shadow-2xl flex flex-col h-[90vh]">
        <header class="text-center mb-4 border-b pb-2">
            <h1 class="text-3xl font-bold text-gray-900">
                <span class="text-indigo-600">Blite</span> | Le Salon Public <span class="text-sm font-normal text-gray-500">(Kinshasa)</span>
            </h1>
        </header>

        <!-- User section (Pseudo and hidden JIA) -->
        <div id="user-info" class="mb-4 bg-indigo-50 p-3 rounded-lg flex justify-between items-center text-sm">
            <div class="flex items-center space-x-2">
                <span class="font-semibold text-indigo-700">Votre Pseudo:</span>
                <p id="current-pseudo" class="font-extrabold text-indigo-600 bg-indigo-100 px-2 py-0.5 rounded"></p>
            </div>
            <button id="toggle-pseudo-edit-btn" class="text-indigo-500 hover:text-indigo-700 transition duration-150 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit mr-1"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                Éditer
            </button>
        </div>
        
        <!-- Pseudo edit form (hidden by default) -->
        <div id="pseudo-edit-form" class="hidden mb-4 p-4 border rounded-lg bg-yellow-50">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">Mettre à jour votre Pseudo</h2>
            <div class="flex space-x-3">
                <input type="text" id="pseudo-input" placeholder="Nouveau Pseudo (ex: KinoisMalin)" maxlength="15"
                       class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition">
                <button id="save-pseudo-btn"
                        class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md disabled:opacity-50" disabled>
                    Sauver
                </button>
            </div>
            <p id="message-area" class="mt-2 text-sm font-medium text-green-600"></p>
        </div>

        <!-- Chat Window -->
        <div id="loading-state" class="text-center py-10">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full"></div>
            <p class="mt-4 text-indigo-600 font-semibold">Chargement du salon de discussion...</p>
        </div>

        <div id="chat-window" class="flex-grow overflow-y-auto space-y-4 p-4 bg-gray-50 rounded-lg shadow-inner mb-4 border border-gray-200 hidden">
            <!-- Messages will be inserted here -->
        </div>

        <!-- Message input area -->
        <div id="message-input-area" class="flex space-x-3">
            <input type="text" id="message-input" placeholder="Écrivez un message anonyme..." 
                   class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition" maxlength="300">
            <button id="send-message-btn"
                    class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-300 shadow-xl disabled:opacity-50 flex items-center justify-center">
                Envoyer
            </button>
        </div>
    </div>

    <!-- Modals and Overlays (Kept for first launch) -->
    <div id="modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-xl">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Attention: Anonymat Éphémère</h3>
            <p class="text-gray-600 mb-6">
                Vous utilisez Blite sans compte. Votre identité **(<span id="modal-pseudo"></span>)** et vos messages sont liés uniquement à cet appareil.
            </p>
            <p class="text-sm text-red-500 font-semibold mb-6">
                Si vous désinstallez l'application, vous perdrez votre identité Blite et votre historique.
            </p>
            <button id="modal-close-btn" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">
                J'ai Compris
            </button>
        </div>
    </div>

    <script type="module">
        // Mandatory Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug'); // Uncomment for debugging

        // --- Mandatory Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-blite-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let bliteID = null; // The Anonymous Identification Token (JIA)
        let currentPseudo = '';

        // Firestore Path Constants
        const PUBLIC_CHAT_PATH = `artifacts/${appId}/public/data/kinshasa_chat`;
        const USER_IDENTITY_PATH = `artifacts/${appId}/users/${userId}/blite_identity`;

        // --- Utilities ---
        const $ = (id) => document.getElementById(id);
        const uniqueId = () => crypto.randomUUID(); // Generates a UUID (JIA)
        
        /**
         * Formats a Firestore timestamp into a readable time (HH:MM).
         * @param {Date | Object} timestamp The Date object or a Firestore object { seconds, nanoseconds }
         * @returns {string} The formatted time.
         */
        const formatTime = (timestamp) => {
            let date;
            if (timestamp && timestamp.toDate) {
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                return 'Unknown';
            }
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        };


        // --- Firebase Initialization ---
        async function initializeBlite() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Error: Firebase configuration is empty.");
                    $('loading-state').innerHTML = `<p class="text-red-600">Erreur: Configuration Firebase manquante.</p>`;
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Anonymous Authentication
                await new Promise(resolve => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken).catch(err => {
                                    console.error("Error signInWithCustomToken:", err);
                                    return signInAnonymously(auth);
                                });
                            } else {
                                await signInAnonymously(auth);
                            }
                            userId = auth.currentUser.uid;
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });

                // 2. JIA (bliteID) Management
                await manageBliteIdentity();
                
                // 3. Start Chat
                loadMessages();

            } catch (e) {
                console.error("Critical error during Blite initialization:", e);
                $('loading-state').innerHTML = `<p class="text-red-600">Erreur: Impossible de se connecter aux services.</p>`;
            }
        }

        // --- Anonymous Identification Token (JIA) Logic ---
        async function manageBliteIdentity() {
            if (!isAuthReady || !userId) return;

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/blite_identity`, 'jia');

            try {
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    // JIA exists: Identity retrieval
                    bliteID = docSnap.data().jia;
                    // The onSnapshot listener will handle pseudo retrieval
                    setupSnapshotListener(userDocRef);
                } else {
                    // JIA does not exist: Creating a new Blite identity
                    bliteID = uniqueId();
                    const defaultPseudo = `KINOIS-${bliteID.substring(0, 4).toUpperCase()}`;

                    const newIdentity = {
                        jia: bliteID,
                        pseudo: defaultPseudo,
                        createdAt: new Date(),
                        geo: "Kinshasa"
                    };

                    await setDoc(userDocRef, newIdentity);
                    setupSnapshotListener(userDocRef);
                    
                    // Display warning modal for the first time
                    $('modal-pseudo').textContent = defaultPseudo;
                    $('modal-container').classList.remove('hidden');
                }

            } catch (error) {
                console.error("Error managing JIA:", error);
                // Display error in loading state if critical
                $('loading-state').innerHTML = `<p class="text-red-600">Erreur lors du chargement de l'identité: ${error.message}</p>`;
            }
        }

        // Real-Time Listener for Pseudo
        function setupSnapshotListener(docRef) {
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentPseudo = data.pseudo;
                    updatePseudoUI(currentPseudo);
                } else {
                    currentPseudo = 'Lost Anonymous';
                    updatePseudoUI(currentPseudo);
                }
            }, (error) => {
                console.error("Error onSnapshot (Identity):", error);
            });
        }
        
        // --- Public Chat Logic ---
        
        let allMessages = []; // Local cache for sorting

        function loadMessages() {
            if (!isAuthReady) return;

            const q = query(collection(db, PUBLIC_CHAT_PATH));
            
            onSnapshot(q, (snapshot) => {
                // Collect all messages into an array
                allMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Local sort by timestamp (better than using Firestore orderBy without index)
                allMessages.sort((a, b) => {
                    const timeA = a.timestamp && a.timestamp.seconds ? a.timestamp.seconds : 0;
                    const timeB = b.timestamp && b.timestamp.seconds ? b.timestamp.seconds : 0;
                    return timeA - timeB;
                });

                renderMessages(allMessages);
                
                // Hide loading state and display chat
                $('loading-state').classList.add('hidden');
                $('chat-window').classList.remove('hidden');
                
            }, (error) => {
                console.error("Error onSnapshot (Chat):", error);
                $('chat-window').innerHTML = `<p class="text-red-500 text-center">Erreur de connexion au chat.</p>`;
            });
        }

        /**
         * Sends the message to the public channel.
         */
        async function sendMessage() {
            const input = $('message-input');
            const messageText = input.value.trim();
            
            if (!messageText || !bliteID || !currentPseudo) return;
            
            $('send-message-btn').disabled = true;
            input.disabled = true;

            const messageData = {
                text: messageText,
                pseudo: currentPseudo,
                jia: bliteID, // The JIA for anonymous identification
                timestamp: new Date(),
                userId: userId, // The Firebase ID (for moderation/security)
            };

            try {
                // Adding the message to the public collection
                await addDoc(collection(db, PUBLIC_CHAT_PATH), messageData);
                input.value = ''; // Clear input after sending

            } catch (e) {
                console.error("Error sending message:", e);
                // Use a temporary message area if sending fails
                const tempMsg = $('message-area');
                tempMsg.className = 'mt-2 text-sm font-medium text-red-600';
                tempMsg.textContent = "Échec de l'envoi. Veuillez réessayer.";
                setTimeout(() => tempMsg.textContent = '', 3000);
            } finally {
                $('send-message-btn').disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        // --- User Interface (UI) Functions ---

        function updatePseudoUI(pseudo) {
            $('current-pseudo').textContent = pseudo;
            $('pseudo-input').value = pseudo;
        }

        function renderMessages(messages) {
            const chatWindow = $('chat-window');
            // Save current scroll position if near the bottom
            const shouldScroll = chatWindow.scrollHeight - chatWindow.scrollTop <= chatWindow.clientHeight + 50;

            chatWindow.innerHTML = messages.map(msg => {
                const isMine = msg.jia === bliteID; // Checks if the message comes from this device's JIA
                
                const alignment = isMine ? 'justify-end' : 'justify-start';
                const bubbleColor = isMine ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800';
                const pseudoColor = isMine ? 'text-indigo-400' : 'text-indigo-600';

                return `
                    <div class="flex ${alignment}">
                        <div class="max-w-xs sm:max-w-md">
                            <div class="text-xs font-semibold ${pseudoColor} mb-0.5 ${isMine ? 'text-right' : 'text-left'}">
                                ${msg.pseudo}
                            </div>
                            <div class="rounded-xl p-3 shadow-md ${bubbleColor}">
                                <p class="text-sm break-words">${msg.text}</p>
                                <span class="block text-right text-xs mt-1 ${isMine ? 'text-indigo-200' : 'text-gray-500'}">
                                    ${formatTime(msg.timestamp)}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Automatic scroll to bottom if the user wasn't reading history
            if (shouldScroll) {
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        // --- User Interaction Management ---

        // Toggle the pseudo edit form display
        $('toggle-pseudo-edit-btn').addEventListener('click', () => {
            const form = $('pseudo-edit-form');
            form.classList.toggle('hidden');
        });

        // Pseudo Update
        async function handleUpdatePseudo() {
            const newPseudo = $('pseudo-input').value.trim();
            const current = $('current-pseudo').textContent;

            if (newPseudo === current) {
                $('message-area').textContent = "Le pseudo est inchangé.";
                return;
            }
            if (newPseudo.length < 3 || newPseudo.length > 15) {
                $('message-area').className = 'mt-2 text-sm font-medium text-red-600';
                $('message-area').textContent = "Le pseudo doit contenir entre 3 et 15 caractères.";
                return;
            }

            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/blite_identity`, 'jia');
                await setDoc(userDocRef, { pseudo: newPseudo }, { merge: true });

                $('message-area').className = 'mt-2 text-sm font-medium text-green-600';
                $('message-area').textContent = "Pseudo mis à jour !";
                $('save-pseudo-btn').disabled = true;

            } catch (error) {
                console.error("Error updating pseudo:", error);
                $('message-area').className = 'mt-2 text-sm font-medium text-red-600';
                $('message-area').textContent = "Erreur de sauvegarde.";
            }
        }

        // Input and Send Button Management
        $('pseudo-input').addEventListener('input', () => {
            const current = $('current-pseudo').textContent;
            const input = $('pseudo-input').value.trim();
            $('save-pseudo-btn').disabled = (input === current || input.length < 3 || input.length > 15);
            $('message-area').textContent = '';
        });

        $('save-pseudo-btn').addEventListener('click', handleUpdatePseudo);

        $('send-message-btn').addEventListener('click', sendMessage);
        
        $('message-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        $('modal-close-btn').addEventListener('click', () => {
            $('modal-container').classList.add('hidden');
        });

        // Initialization
        window.onload = initializeBlite;

    </script>
</body>
</html>
