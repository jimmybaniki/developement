<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAISONSDUJOUR - Catalogue Dynamique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html { font-family: 'Inter', sans-serif; }
        .whitespace-pre-wrap { white-space: pre-wrap; }
    </style>
    <script>
        // --- CONFIGURATION GOOGLE SHEETS ---
        // Remplacez l'URL ci-dessous par votre lien "Publier sur le web" au format CSV
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/11Db3aKWbdHs16_3OFxg9fGhnyfNawBtriBcg9dkrhl8/edit?usp=sharing";
        const WHATSAPP_NUMBER = '243978415814';

        let allProperties = []; // Stockage global des donn√©es du Sheet

        // Fonction pour charger les donn√©es depuis Google Sheets
        async function fetchSheetData() {
            try {
                const response = await fetch(SHEET_CSV_URL);
                const data = await response.text();
                const rows = data.split('\n').slice(1); // On ignore l'en-t√™te

                allProperties = rows.map(row => {
                    const columns = row.split(',');
                    return {
                        id: columns[0],
                        title: columns[1],
                        price: columns[2],
                        description: columns[3],
                        imageUrl: columns[4],
                        videoUrl: columns[5],
                        commune: columns[6],
                        district: columns[7],
                        isFeatured: columns[8]?.trim().toLowerCase() === "oui"
                    };
                }).filter(p => p.id); // On garde uniquement les lignes avec un ID

                renderFeaturedProperties();
            } catch (error) {
                console.error("Erreur de chargement Google Sheets:", error);
            }
        }

        // Fonction WhatsApp (Inchang√©e mais optimis√©e)
        function orderCommissionnaireNumber(propertyRef, commissionPrice = 3) {
            const messageBox = document.getElementById('message-box');
            messageBox.classList.remove('hidden');
            messageBox.innerHTML = `<div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg shadow-md mb-6"><p class="text-sm font-medium text-blue-800">Redirection vers WhatsApp...</p></div>`;
            
            const message = encodeURIComponent(`Bonjour MAISONSDUJOUR, je souhaite payer ${commissionPrice}$ pour la propri√©t√© Ref: ${propertyRef}.`);
            setTimeout(() => {
                window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${message}`, '_blank');
                messageBox.classList.add('hidden');
            }, 1000);
        }

        // Afficher les 10 propri√©t√©s "√Ä la Une" (celles marqu√©es "oui" dans le Sheet)
        function renderFeaturedProperties() {
            const container = document.getElementById('featured-catalogue');
            const featured = allProperties.filter(p => p.isFeatured).slice(0, 10);
            
            let html = `<h3 class="text-3xl font-bold text-gray-700 mb-8 border-b border-gray-200 pb-3">üî• 10 Propri√©t√©s √† la Une</h3>`;
            html += `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">`;

            featured.forEach(prop => {
                html += generateCardHTML(prop);
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        // Recherche par district et commune
        function displayCommuneHouses(districtName, selectElement) {
            const communeName = selectElement.value;
            const resultDisplay = document.getElementById('result-display');
            
            const houses = allProperties.filter(p => p.commune.trim() === communeName.trim());
            
            let housesHtml = '';
            houses.forEach(house => { housesHtml += generateCardHTML(house, true); });

            resultDisplay.classList.remove('hidden');
            resultDisplay.innerHTML = `
                <div class="p-6 bg-white rounded-xl shadow-2xl border-t-8 border-emerald-600">
                    <h3 class="text-3xl font-bold text-emerald-700 mb-2">${communeName}</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">${housesHtml}</div>
                    <button onclick="document.getElementById('result-display').classList.add('hidden')" class="mt-10 px-6 py-3 bg-gray-500 text-white rounded-lg">Fermer</button>
                </div>`;
            resultDisplay.scrollIntoView({ behavior: 'smooth' });
        }

        // G√©n√©rateur de carte HTML (G√®re image et vid√©o)
        function generateCardHTML(prop, isLarge = false) {
            const mediaHeight = isLarge ? 'h-96' : 'h-40';
            let mediaZone = `<img src="${prop.imageUrl}" class="${mediaHeight} w-full object-cover">`;
            
            // Si une vid√©o YouTube est pr√©sente, on l'affiche √† la place
            if (prop.videoUrl && prop.videoUrl.includes('youtube.com')) {
                const vId = prop.videoUrl.split('v=')[1]?.split('&')[0];
                mediaZone = `<iframe class="${mediaHeight} w-full" src="https://www.youtube.com/embed/${vId}" frameborder="0" allowfullscreen></iframe>`;
            }

            return `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 relative">
                    ${mediaZone}
                    <p class="absolute top-0 right-0 bg-emerald-600 text-white text-xs font-bold py-1 px-3 rounded-bl-lg">R√©f: ${prop.id}</p>
                    <div class="p-4">
                        <h4 class="text-xl font-bold text-gray-900 mb-2">${prop.title}</h4>
                        <p class="text-sm text-gray-700 mb-4 whitespace-pre-wrap">${prop.description}</p>
                        <div class="mb-4 pt-2 border-t font-bold text-2xl text-emerald-600">${prop.price}$ <span class="text-xs text-gray-500">/mois</span></div>
                        <button onclick="orderCommissionnaireNumber('${prop.id}', 3)" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold">Commander le num√©ro (3$)</button>
                    </div>
                </div>`;
        }

        const districtsData = {
            'Lukunga': ['Gombe', 'Kinshasa', 'Lingwala', 'Kintambo', 'Ngaliema', 'Mont-Ngafula', 'Selembao (partiel)'],
            'Mont-Amba': ['Lemba', 'Limete', 'Matete', 'Kisenso', 'Ngaba', 'Mont-Ngafula (partiel)'],
            'Tshangu': ['Masina', 'Ndjili', 'Kimbanseke', 'Maluku', 'Nsele'],
            'Funa': ['Bandalungwa', 'Kalamu', 'Bumbu', 'Makala', 'Ngiri-Ngiri', 'Kasa-Vubu']
        };

        document.addEventListener('DOMContentLoaded', () => {
            Object.keys(districtsData).forEach(district => {
                const select = document.getElementById(`select-${district.replace('-', '').toLowerCase()}`);
                if (select) {
                    select.innerHTML = `<option value="" disabled selected>S√©lectionnez une commune</option>`;
                    districtsData[district].forEach(c => { select.innerHTML += `<option value="${c}">${c}</option>`; });
                }
            });
            fetchSheetData();
        });
    </script>
</head>
<body class="bg-gray-50">
    <header class="bg-white shadow-md sticky top-0 z-10 p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-emerald-600">MAISONSDUJOUR</h1>
            <a href="commissionnaire_submission.html" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm">Espace Agent</a>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-12">
        <div id="message-box" class="hidden"></div>
        
        <h2 class="text-3xl font-bold mb-8">Recherche par District</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
            <div class="bg-white p-6 rounded-xl shadow border-t-4 border-red-500">
                <h3 class="text-xl font-bold text-red-600 mb-3">Lukunga</h3>
                <select id="select-lukunga" onchange="displayCommuneHouses('Lukunga', this)" class="w-full p-2 border rounded"></select>
            </div>
            <div class="bg-white p-6 rounded-xl shadow border-t-4 border-blue-500">
                <h3 class="text-xl font-bold text-blue-600 mb-3">Mont-Amba</h3>
                <select id="select-montamba" onchange="displayCommuneHouses('Mont-Amba', this)" class="w-full p-2 border rounded"></select>
            </div>
            <div class="bg-white p-6 rounded-xl shadow border-t-4 border-green-500">
                <h3 class="text-xl font-bold text-green-600 mb-3">Tshangu</h3>
                <select id="select-tshangu" onchange="displayCommuneHouses('Tshangu', this)" class="w-full p-2 border rounded"></select>
            </div>
            <div class="bg-white p-6 rounded-xl shadow border-t-4 border-purple-500">
                <h3 class="text-xl font-bold text-purple-600 mb-3">Funa</h3>
                <select id="select-funa" onchange="displayCommuneHouses('Funa', this)" class="w-full p-2 border rounded"></select>
            </div>
        </div>

        <div id="result-display" class="hidden mb-12"></div>
        <section id="featured-catalogue"></section>
    </main>
</body>
</html>
